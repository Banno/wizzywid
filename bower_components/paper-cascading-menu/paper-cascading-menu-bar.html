<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selectable.html">
<link rel="import" href="../iron-a11y-keys-behavior/iron-a11y-keys-behavior.html">
<dom-module id="paper-cascading-menu-bar">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: row;
        box-sizing: border-box;
        background-color: #fff;
      }
    </style>
    <slot></slot>
  </template>
  <script>
    Polymer({
      is: 'paper-cascading-menu-bar',

      behaviors: [
        Polymer.IronSelectableBehavior,
        Polymer.IronA11yKeysBehavior
      ],

      properties: {
        selectedAttribute: {
          type: String,
          value: 'active'
        },

        alignmentPreference: {
          type: String,
          readOnly: true,
          value: 'bottom'
        }
      },

      listeners: {
        'paper-cascading-menu-attached': '__onPaperCascadingMenuAttached',
        'paper-cascading-menu-selection': '__onPaperCascadingMenuSelection',
      },

      keyBindings: {
        'right': '__onRightArrow',
        'up': '__onUpArrow',
        'left': '__onLeftArrow',
        'down': '__onDownArrow',
        'esc': '__onEsc',
      },

      ready: function() {
        this.__boundOnBlur = this.__onBlur.bind(this);
        this.__boundOnGlobalClick = this.__onGlobalClick.bind(this);
      },

      attached: function() {
        var ownerRoot;

        if (Polymer.Settings.useShadow && !Polymer.Settings['wc-shadydom']) {
          ownerRoot = Polymer.dom(this).getOwnerRoot();
        }

        this.__ownerRoot = ownerRoot || document;

        window.addEventListener('click', this.__boundOnGlobalClick);
      },

      detached: function() {
        window.removeEventListener('click', this.__boundOnGlobalClick);
      },

      __onPaperCascadingMenuAttached: function(event) {
        var target = Polymer.dom(event).localTarget;
        event.stopImmediatePropagation();
        target.isRootMenu = true;
      },

      __onPaperCascadingMenuSelection: function(event) {
        event.detail.selectionPath.unshift(this.selectedItem);

        this.async(function() {
          if (event.defaultPrevented) {
            return;
          }

          this.selected = null;
        });
      },

      __onBlur: function(event) {
        this.debounce('onBlur', function() {
          var focusTarget = this.__ownerRoot.activeElement;
          var containsTarget = Polymer.dom(this).deepContains(focusTarget);

          if (!containsTarget) {
            this.selected = null;
          }
        });
      },

      __onGlobalClick: function(event) {
        var path = Polymer.dom(event).path;

        if (path.indexOf(this) === -1) {
          this.selected = null;
        }
      },

      __onEsc: function() {
        console.log('Esc!');
        this.selected = null;
      },

      __onRightArrow: function() {

      },

      __onLeftArrow: function() {
      },

      __onUpArrow: function() {
      },

      __onDownArrow: function() {
      }
    });
  </script>
</dom-module>
