<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-selector/iron-selectable.html">
<link rel="import" href="../iron-selector/iron-selectable.html">
<link rel="import" href="../paper-styles/shadow.html">

<dom-module id="paper-cascading-menu">
  <template>
    <style>
      :host {
        contain: layout;

        position: absolute;
        box-sizing: border-box;
        background-color: #fff;
        z-index: 1;

        width: 320px;

        border-radius: 2px;
        @apply --shadow-elevation-4dp;

        overflow: hidden;

        transition: transform 0.2s, opacity 0.2s;
      }

      :host([narrow]) {
        width: 288px;
      }

      :host(.is-root-menu:not(.open)) {
        transform: translateY(-30px) scale(1, 0.75);
      }

      :host(:not(.open)) {
        opacity: 0;
        transform: translateY(-3px) scale(0.85, 0.75);
        transform-origin: 0 0;
        pointer-events: none;
      }

      :host(.open) {
        opacity: 1;
        transform: translateY(0) scale(1);
        transform-origin: 0 0;
      }

      #content {
        position: relative;
        display: flex;
        flex-direction: column;
        top: 0;
        left: 0;
        padding: 16px 0;

        transition: transform 0.2s;
      }

      :host(.open) #content {
        transform: translateY(0) scale(1);
        transform-origin: 0 0;
      }

      :host(.is-root-menu:not(.open)) #content {
        transform: translateY(0) scale(1, calc(1/0.77));
        transform-origin: 0 0;
      }

      :host(:not(.open)) #content {
        transform: translateY(0) scale(calc(1/0.88), calc(1/0.77));
        transform-origin: 0 0;
      }

      :host(.has-selection) {
        overflow: visible;
        @apply --shadow-elevation-2dp;
      }

      :host(:not(.default-orientation)),
      :host(:not(.default-orientation)) #content {
        transform-origin: top right;
      }

    </style>
    <div id="content">
      <slot></slot>
    </div>
  </template>
  <script>
    (function() {
      Polymer({
        is: 'paper-cascading-menu',

        behaviors: [
          Polymer.IronSelectableBehavior,
          Polymer.IronResizableBehavior
        ],

        properties: {
          fitElement: {
            type: Object,
            value: null
          },

          isRootMenu: {
            type: Boolean,
            value: false,
            observer: '__isRootMenuChanged'
          },

          fitRect: {
            type: Object,
            readOnly: true,
            value: null
          },

          alignmentRect: {
            type: Object,
            readOnly: true,
            value: null
          },

          boundingRect: {
            type: Object,
            readOnly: true,
            value: null
          },

          selectedAttribute: {
            type: String,
            value: 'active'
          },

          narrow: {
            type: Boolean,
            reflectToAttribute: true,
            value: false
          },

          disabled: {
            type: Boolean,
            value: false,
            observer: '__disabledChanged'
          }
        },

        listeners: {
          'paper-cascading-menu-attached': '__onPaperCascadingMenuAttached',
          'paper-cascading-menu-selection': '__onPaperCascadingMenuSelection',
          'paper-cascading-option-enter': '__onPaperCascadingOptionEnter',
          'iron-resize': '__onIronResize',
          'mouseover': '__onMouseover',
        },

        observers: [
          '__selectedChanged(selected)'
        ],

        attached: function() {
          this.__parent = Polymer.dom(this).parentNode;
          this.close();
          Polymer.RenderStatus.afterNextRender(this, function() {
            this.fire('paper-cascading-menu-attached');
            this.measure();
          });
        },

        detached: function() {
          this.__parent = null;
        },

        measure: function() {
          this.debounce('measure', function() {
            this.__updateBoundingRect();
            this.__updateFitRect();
            this.__updateAlignmentRect();
            this.updateLayout();
          });
        },

        updateLayout: function() {
          var primaryOrientation;
          var adjacentOrientation;

          var opposingPrimaryOrientation;
          var opposingAdjacentOrientation;

          var primaryDimension;
          var adjacentDimension;

          var adjacentAlignInside;

          if (this.isRootMenu) {
            primaryOrientation = 'top';
            adjacentOrientation = 'left';
            opposingPrimaryOrientation = 'top';
            opposingAdjacentOrientation = 'right';
            primaryDimension = 'height';
            adjacentDimension = 'width';

            adjacentAlignInside = true;
          } else {
            primaryOrientation = 'left';
            adjacentOrientation = 'top';
            opposingPrimaryOrientation = 'right';
            opposingAdjacentOrientation = 'bottom';
            primaryDimension = 'width';
            adjacentDimension = 'height';

            adjacentAlignInside = true;
          }

          var primaryPosition = this.alignmentRect[primaryOrientation];
          var adjacentPosition = this.alignmentRect[adjacentOrientation];
          var opposingPrimaryPosition = this.alignmentRect[opposingPrimaryOrientation];
          var opposingAdjacentPosition = this.alignmentRect[opposingAdjacentOrientation];

          var requiredSpan = primaryPosition +
              this.alignmentRect[primaryDimension] +
              this.boundingRect[primaryDimension];
          var containerLimit = this.fitRect[primaryDimension] -
              this.fitRect[primaryOrientation];

          var defaultOrientation = requiredSpan <= containerLimit;

          this.style[primaryOrientation] =
              this.style[adjacentOrientation] =
              this.style[opposingPrimaryOrientation] =
              this.style[opposingAdjacentOrientation] = '';

          this.classList.toggle('default-orientation', defaultOrientation);

          if (defaultOrientation) {
            this.style[primaryOrientation] = '100%';
            this.style[adjacentOrientation] = adjacentAlignInside
                ? '0%'
                : '100%';
          } else {
            this.style[opposingPrimaryOrientation] = '100%';
            this.style[adjacentOrientation] = adjacentAlignInside
                ? '0%'
                : '100%';
          }
        },

        open: function() {
          this.disabled = false;
          this.classList.add('open');
        },

        close: function() {
          this.selected = null;
          this.disabled = true;
          this.classList.remove('open');
        },

        __isRootMenuChanged: function() {
          this.classList.toggle('is-root-menu', this.isRootMenu);
        },

        __onPaperCascadingOptionEnter: function(event) {
          var target = Polymer.dom(event).localTarget;
          var index = Array.from(Polymer.dom(this).children).indexOf(target)

          event.stopImmediatePropagation();

          if (index > -1) {
            this.cancelDebouncer('deselect');
            this.selectIndex(index);
          }
        },

        __onPaperCascadingMenuSelection: function(event) {
          var target = Polymer.dom(event).localTarget;

          if (target === this) {
            return;
          }

          event.detail.selectionPath.unshift(this.selectedItem);
        },

        __onMouseover: function(event) {
          var path = Polymer.dom(event).path;

          if (path.indexOf(this.selectedItem) === -1) {
            this.debounce('deselect', function() {
              this.selected = null;
              this.focus();
            }, 50);
          }

          event.stopImmediatePropagation();
        },

        __onIronResize: function(event) {
          this.measure();
        },

        __onPaperCascadingMenuAttached: function(event) {
          var target = Polymer.dom(event).localTarget;
          if (target !== this) {
            event.stopImmediatePropagation();
            target.isRootMenu = false;
          }
        },

        __measureFitElement: function() {
          return this.fitElement != null
              ? this.fitElement.getBoundingClientRect()
              : {
                  top: 0,
                  left: 0,
                  bottom: window.innerHeight,
                  right: window.innerWidth,
                  width: window.innerWidth,
                  height: window.innerHeight
                };
        },

        __measureParent: function() {
          return this.__parent != null
              ? this.__parent.getBoundingClientRect()
              : this.fitRect;
        },

        __measureSelf: function() {
          var styleAttributeValue = this.getAttribute('style');
          this.setAttribute('style', 'transform:none');
          var rect = this.getBoundingClientRect();
          this.setAttribute('style', styleAttributeValue);
          return rect;
        },

        __updateFitRect: function() {
          this._setFitRect(this.__measureFitElement());
        },

        __updateAlignmentRect: function() {
          this._setAlignmentRect(this.__measureParent());
        },

        __updateBoundingRect: function() {
          this._setBoundingRect(this.__measureSelf());
        },

        __selectedChanged: function() {
          this.classList.toggle('has-selection', this.selected != null);

          if (this.selectedItem != null && !this.selectedItem.isSubmenu) {
            this.fire('paper-cascading-menu-selection', {
              selectionPath: [this.selectedItem]
            }, {
              bubbles: true,
              composed: true,
              cancelable: true
            });
          }
        },

        __disabledChanged: function(disabled) {
          this.debounce('disabled-changed', function() {
            this.items.forEach(function(item) {
              item.disabled = this.disabled;
            }, this);
          });
        }
      });
    })();
  </script>
</dom-module>
