<link rel="import" href="../bower_components/polymer/polymer-element.html">
<dom-module id="action-history">
  <template>
    <style>
      :host {
        display: none;
      }
    </style>
  </template>
  <script>
    class ActionHistory extends Polymer.Element {
      static get is() { return 'action-history'; }
      constructor() {
        super();
        this.undoHistory = [];
        this.redoHistory = [];
      }

      add(action, node, detail) {
        let item = {
          action: action,
          node: node,
          detail: detail
        };

        // This may be a dumb action where the old === new (like when you
        // start dragging but don't get anywhere)
        if (detail && detail.new && detail.old &&
            this._itemsMatch(action, detail.new, detail.old)) {
          return;
        }

        let topItem = this.undoHistory[this.undoHistory.length - 1];

        // This may be the same action as the previous one.
        if (topItem &&
            item.action === topItem.action &&
            topItem.node === item.node &&
            item.detail && topItem.detail &&
            this._itemsMatch(item.action, item.detail, topItem.detail)) {
          return;
        }

        this.undoHistory.push(item);

        // A new item in the undo stack means you have nothing to redo.
        this.redoHistory = [];
        this.updateButtons();
      }

      undo() {
        // Take the top action off the undo stack and move it to the redo stack.
        let item = this.undoHistory.pop();
        let detail = item.detail;
        this.redoHistory.push(item);
        this.updateButtons();

        switch(item.action) {
          case 'update':
              item.node.click();
              shell.updateActiveElementValues(detail.type, detail.name, detail.old.value);
              break;
          case 'new':
              let newEvent = new Event('remove-from-canvas', {
                bubbles: true,
                cancelable: false,
                composed: true
              });
              newEvent.detail = {target: item.node};
              this.dispatchEvent(newEvent);
              break;
          case 'delete':
              // If the node is the viewContainer, the `type` property contains the old innerHTML
              if (item.node.id === 'viewContainer') {
                item.node.setInnerHTML(detail.innerHTML);
              } else {
                // The `type` property contains the original parent.
                detail.parent.appendChild(item.node);
              }
              item.node.click();
              break;
          case 'move':
              item.node.style.left = detail.old.left;
              item.node.style.top = detail.old.top;
              // During reparent-and-move we may have switched to position:relative.
              if (detail.old.position) {
                item.node.style.position = detail.old.position;
              }
              item.node.click();
              break;
          case 'resize':
              item.node.style.width = detail.old.width;
              item.node.style.height = detail.old.height;
              item.node.click();
              break;
          case 'reparent':
              detail.new.parent.removeChild(item.node);
              detail.old.parent.appendChild(item.node);
              item.node.style.left = detail.old.left;
              item.node.style.top = detail.old.top;
              // During reparent-and-move we may have switched to position:relative.
              if (detail.old.position) {
                item.node.style.position = detail.old.position;
              }
              item.node.click();
              break;
          case 'fit':
              item.node.style.left = detail.old.left;
              item.node.style.top = detail.old.top;
              item.node.style.width = detail.old.width;
              item.node.style.height = detail.old.height;
              item.node.style.position = detail.old.position;
              item.node.click();
              break;
          case 'move-up':
          case 'move-down':
              item.detail.new.parent.removeChild(item.node);
              item.detail.old.parent.appendChild(item.node);
              item.node.click();
              break;
          case 'move-back':
              item.node.click();
              shell.moveForward(false);
              break;
          case 'move-forward':
              item.node.click();
              shell.moveBack(false);
              break;
        }
      }

      redo() {
        // Take the top action off the redo stack and move it to the undo stack.
        let item = this.redoHistory.pop();
        let detail = item.detail;
        this.undoHistory.push(item);
        this.updateButtons();

        switch(item.action) {
          case 'update':
              item.node.click();
              shell.updateActiveElementValues(detail.type, detail.name, detail.new.value);
              break;
          case 'new':
              let newEvent = new Event('add-to-canvas', {
                bubbles: true,
                cancelable: false,
                composed: true
              });
              newEvent.detail = {target: item.node};
              this.dispatchEvent(newEvent);
              break;
          case 'delete':
              // If the node is the viewContainer, clear its inner HTML.
              if (item.node.id === 'viewContainer') {
                item.node.setInnerHTML('');
                item.node.click();
              } else {
                item.node.parentElement.click();
                item.node.parentElement.removeChild(item.node);
              }
              break;
          case 'move':
              item.node.style.left = detail.new.left;
              item.node.style.top = detail.new.top;
              // During reparent-and-move we may have switched to position:relative.
              if (detail.old.position) {
                item.node.style.position = detail.new.position;
              }
              item.node.click();
              break;
          case 'resize':
              item.node.style.width = detail.new.width;
              item.node.style.height = detail.new.height;
              item.node.click();
              break;
          case 'reparent':
              detail.old.parent.removeChild(item.node);
              detail.new.parent.appendChild(item.node);
              item.node.style.left = detail.new.left;
              item.node.style.top = detail.new.top;
              // During reparent-and-move we may have switched to position:relative.
              if (detail.old.position) {
                item.node.style.position = detail.new.position;
              }
              item.node.click();
              break;
          case 'fit':
              item.node.style.left = detail.new.left;
              item.node.style.top = detail.new.top;
              item.node.style.width = detail.new.width;
              item.node.style.height = detail.new.height;
              item.node.style.position = detail.new.position;
              item.node.click();
              break;
          case 'move-up':
          case 'move-down':
              item.detail.old.parent.removeChild(item.node);
              item.detail.new.parent.appendChild(item.node);
              item.node.click();
              break;
          case 'move-back':
              item.node.click();
              shell.moveForward(false);
              break;
          case 'move-forward':
              item.node.click();
              shell.moveBack(false);
              break;
        }
      }

      updateButtons() {
        shell.updateUndoButton(this.undoHistory.length);
        shell.updateRedoButton(this.redoHistory.length);
      }

      _itemsMatch(action, first, second) {
        // These have elements in the details, and you can't json those anyway.
        if (action === 'reparent' || action === 'move-up' || action === 'move-down') {
          return false;
        }
        return JSON.stringify(first) === JSON.stringify(second);
      }
    }
    customElements.define(ActionHistory.is, ActionHistory);
  </script>
</dom-module>
