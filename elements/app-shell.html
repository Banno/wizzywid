<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="app-icons.html">
<link rel="import" href="designer-tabs.html">
<link rel="import" href="designer-tab.html">

<dom-module id="app-shell">
  <template>
    <style>
      :host{
        display: block;
        box-sizing: border-box;
      }
      app-header {
        background-color: #eeeeee;
        color: black;
      }
      app-drawer {
        width: 350px;
        border-left: 1px solid silver;
      }
      .drawer-contents {
        text-align: left;
      }
      .drawer-contents app-toolbar {
        background-color: #eeeeee;
        color: black;
      }
      .separator {
        border-left: #656565 solid 1px;
        opacity: .8;
        height: 24px;
        margin: 8px;
      }
      span, paper-icon-button {
        margin: 8px;
      }
      iron-pages {
        padding: 8px 14px;
      }
      iron-pages.styles {
        height: 300px;
        overflow: auto;
      }
    </style>

    <app-drawer-layout>
      <app-drawer slot="drawer" id="drawer" align="right">
        <div class="drawer-contents">
          <app-toolbar>
            <!-- <paper-icon-button icon="designer:back"></paper-icon-button> -->
            <span>{{activeElementName}}</span>
            <!-- <paper-icon-button icon="designer:fullscreen"></paper-icon-button>-->
            <paper-icon-button icon="designer:delete" on-click="deleteActiveElement"></paper-icon-button>
          </app-toolbar>
          <div>
            <designer-tabs attr-for-selected="name" selected="{{stylePage}}">
              <designer-tab name="properties">
                <button>properties</button>
              </designer-tab>
              <designer-tab name="styles">
                <button>styles</button>
              </designer-tab>
              <designer-tab name="flex">
                <button>flex</button>
              </designer-tab>
            </designer-tabs>

            <iron-pages class="styles" role="main" selected="[[stylePage]]" attr-for-selected="name" selected-attribute="visible">
              <div name="properties">
                <slot name="properties"></slot>
              </div>
              <div name="styles">
                <slot name="styles"></slot>
              </div>
              <div name="flex">
                <slot name="flex"></slot>
              </div>
            </iron-pages>

            <designer-tabs attr-for-selected="name" selected="{{elementsPage}}">
              <designer-tab name="elements" selected>
                <button>elements</button>
              </designer-tab>
              <designer-tab name="tree">
                <button>tree</button>
              </designer-tab>
            </designer-tabs>
            <iron-pages selected="[[elementsPage]]" attr-for-selected="name" selected-attribute="visible">
              <div name="elements">
                <slot name="elements"></slot>
              </div>
              <div name="tree">
                <slot name="tree"></slot>
              </div>
            </iron-pages>
          </div>
        </div>
      </app-drawer>
      <app-header-layout>
        <app-header slot="header" fixed>
          <app-toolbar>
            <span title="it's like MSPaint but for Polymer">PolymerPaint</span>
            <div class="separator"></div>
            <paper-icon-button icon="designer:code" on-click="dump"></paper-icon-button>
            <div class="separator"></div>
            <!-- <paper-icon-button disabled icon="designer:save"></paper-icon-button>
            <paper-icon-button disabled icon="designer:share"></paper-icon-button>
            <paper-icon-button disabled icon="designer:launch"></paper-icon-button>
            <div class="separator"></div> -->
            <paper-icon-button disabled icon="designer:undo"></paper-icon-button>
            <paper-icon-button disabled icon="designer:redo"></paper-icon-button>
            <div class="separator"></div>
            <paper-icon-button icon="designer:drawer" onclick="drawer.toggle()"></paper-icon-button>
          </app-toolbar>
        </app-header>

        <slot name="main"></slot>
        <div>
          <pre><code id="code"></code></pre>
        </div>
      </app-header-layout>
    </app-drawer-layout>

  </template>
  <script>
    class AppShell extends Polymer.Element {
      static get is() { return 'app-shell'; }
      static get properties() {
        return {
          activeElement: {
            type: Object
          },
          activeElementName: {
            type: String
          },
          stylesPage: {
            type:String
          },
          elementsPage: {
            type:String
          }
        }
      }

      ready() {
        super.ready();
        this.stylePage = 'properties';
        this.elementsPage = 'elements';
      }

      updateActiveElement(el) {
        if (this.activeElement) {
          this.activeElement.classList.remove('active');
        }
        el.classList.add('active');
        this.activeElement = el;
        this.computeActiveElementName();
      }

      updateActiveElementValues(type, name, value) {
        if (type === 'style') {
          // If we switch to flexbox, automatically reposition the children
          if (name === 'display' && value === 'flex') {
            var children = this.activeElement.children;
            for (var i = 0; i < children.length; i++) {
              children[i].style.position = 'relative';
              children[i].style.top = children[i].style.left = 'auto';
            }
          }
          this.activeElement.style[name] = value;
        } else {
          if (value === 'true') {
            this.activeElement[name] = true;
          } else if (value === 'false') {
            if (this.activeElement.hasAttribute(name)) {
              this.activeElement.removeAttribute(name);
            } else {
              this.activeElement[name] = false;
            }
          } else {
            this.activeElement[name] = value;
          }

          // We're displaying the id, so update it in the title bar.
          if (name === 'id') {
            this.computeActiveElementName();
          }
        }
      }

      deleteActiveElement() {
        // Deleting the whole app should remove the children I guess.
        if (this.activeElement.id === 'viewContainer') {
          this.activeElement.innerHTML = '';
        } else {
          this.activeElement.parentElement.removeChild(this.activeElement);
          this.activeElement = null;
        }
        this.computeActiveElementName();
        // TODO: ew.
        window.displayElement();
        window.recomputeTree();
      }

      // TODO: ugh, this can probably be better.
      computeActiveElementName() {
        if (this.activeElement === null || this.activeElement.id == 'viewContainer') {
          this.activeElementName = 'main-app';
        } else {
          var name = this.activeElement.tagName.toLowerCase();
          if (this.activeElement.id) {
            name += '#' + this.activeElement.id;
          }
          this.activeElementName = name;
        }
      }

      dump() {
        // Imports
        var imports = '';
        var template = '';
        var hostStyle = ':host {}';
        var style = 'div {}';

        var nodes = viewContainer.children;
        var indent = '      ';
        for (var i = 0; i < nodes.length; i++) {
          // Add to the import if needed.
          var tag = nodes[i].tagName.toLowerCase();
          if (tag.indexOf('-') !== -1 && imports.indexOf(`${tag}.html`) === -1) {
            imports += this.dumpImports(tag, '  ') + '\n';
          }
          template += this.dumpElement(nodes[i], indent) + '\n';
        }

        var boilerplate = `
${imports}
  <dom-module id="main-app">
    <template>
      <style>
      ${hostStyle}
      ${style}
      </style>

${template}
    </template>
    <script>
      class MainApp extends Polymer.Element {
        static get is() { return 'main-app'; }
      }
      customElements.define(MainApp.is, MainApp);
    &lt;/script>
</dom-module>`;

        boilerplate = boilerplate.replace(/</g, '&lt;');
        boilerplate = boilerplate.replace(/>/g, '&gt;');
        console.log(boilerplate);
        this.$.code.innerHTML = boilerplate;
      }

      dumpElement(node, indent) {
        var tag = node.tagName.toLowerCase();
        var id = node.id ? ` id="${node.id}"` : '';
        var text = node.textContent || '';
        return tag === 'input' ?
            `${indent}<${tag}${id}>` :
            `${indent}<${tag}${id}>${text}</${tag}>`
      }

      dumpImports(tag, indent) {
        return `${indent}<link rel="import" href="../${tag}/${tag}.html">`;
      }
      //
      // dumpChildren(node, indent) {
      //   var children = '';
      //   var indent = indent || '';
      //   Array.prototype.forEach.call(node.children, function(c) {
      //     children += this.dumpTag(c, indent);
      //   }, this);
      //   return children || (indent + '\n');
      // }


    }
    customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>
