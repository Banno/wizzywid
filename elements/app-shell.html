<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="app-icons.html">
<link rel="import" href="designer-tabs.html">
<link rel="import" href="designer-tab.html">
<link rel="import" href="elements-palette.html">
<link rel="import" href="samples-palette.html">

<link rel="import" href="action-history.html">
<link rel="import" href="tree-view.html">
<link rel="import" href="element-styles.html">
<link rel="import" href="element-flex.html">
<link rel="import" href="element-properties.html">
<link rel="import" href="canvas-view.html">

<script src="../third-party/ace.js" type="text/javascript" charset="utf-8"></script>
<dom-module id="app-shell">
  <template>
    <style>
      :host{
        display: block;
        box-sizing: border-box;
        position: relative;
      }

      app-header {
        background-color: #373737;
        color: white;
        height: 60px;
        width: 100%;
        position: fixed;
        z-index: 100;
      }

      app-header .app-title {
        margin-right: 8px;
      }

      button {
        background: transparent;
        border: none;
        cursor: pointer;
      }

      designer-tab button {
        margin: 0 8px;
      }

      app-header button {
        color: white;
        text-align: center;
        margin: 8px;
      }

      app-header button[disabled] {
        opacity: 0.3;
      }

      designer-tab.single {
        background-color: #efefef;
        color: #5d5d5d;
        width: 100%;
        padding-left: 8px;
      }

      .separator {
        border-left: #656565 solid 1px;
        opacity: .8;
        height: 24px;
        margin: 8px;
      }

      .container {
        box-sizing: border-box;
        display: flex;
        flex-direction: row;
        padding-top: 60px;
        height: 100vh;
      }

      .drawer {
        min-width: 300px;
        width: 300px;
        height: 100%;
        overflow: hidden;
        background: white;
        color: #5d5d5d;
      }

      .drawer.small {
        min-width: 250px;
        width: 250px;
      }

      .main-view {
        height: 100%;
        width: 100%;
        overflow: auto;
        display: flex;
        flex-grow: 1;
        border-left: 1px solid #e5e5e5;
        border-right: 1px solid #e5e5e5;
      }

      .drawer-title {
        padding: 14px 0;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        line-height: 1.5;
        color: inherit;
      }

      [hidden] {
        display: none !important;
      }

      iron-pages {
        height: 250px;
        overflow:hidden;
        padding-bottom: 20px;
      }

      iron-pages.elements {
        height: calc(100% - 250px - 40px - 40px - 20px) !important;
      }

      iron-pages > div {
        height: 100%;
      }

      button.button-code iron-icon {
        transform: rotate(0deg);
      }

      button.button-code.active iron-icon {
        transform: rotate(90deg);
      }

      .actions {
        display: flex;
        padding: 10px 0;
        font-size: 10px;
        justify-content: space-around;
      }
      .actions button {
        padding: 0;
      }

    </style>

    <action-history id="actionHistory"></action-history>

    <app-header fixed>
      <app-toolbar>
        <span class="app-title" title="it's like Dreamweaver but for Polymer apps">PolyWeaver</span>
        <div class="separator"></div>
        <button on-click="viewCode" class="button-code">
          <iron-icon icon="designer:code"></iron-icon>
          <div>Code</div>
        </button>
        <button on-click="jsFiddleIt">
          <iron-icon icon="designer:view"></iron-icon>
          <div>jsFiddle</div>
        </button>
        <div class="separator"></div>
        <button on-click="undo" id="undoBtn" disabled>
          <iron-icon icon="designer:undo"></iron-icon>
          <div>Undo</div>
        </button>
        <button on-click="redo" id="redoBtn" disabled>
          <iron-icon icon="designer:redo"></iron-icon>
          <div>Redo</div>
        </button>
      </app-toolbar>
    </app-header>
    <div class="container" id="scrollingRegion">
      <div class="drawer small">
        <designer-tab class="single">
          <button>tree</button>
        </designer-tab>
        <tree-view name="tree" id="treeView"></tree-view>
      </div>

      <div class="main-view">
        <canvas-view id="viewContainer" style="width:100%"></canvas-view>
        <div id="codeContainer" style="width:100%" hidden>
          <slot name="code"></slot>
        </div>
      </div>

      <div class="drawer">
        <designer-tab class="single"><span>Actions</span></designer-tab>
        <div class="actions">
          <button on-click="deleteElement">
            <iron-icon icon="designer:delete"></iron-icon>
            <div>Delete</div>
          </button>
          <button on-click="cloneElement">
            <iron-icon icon="designer:copy"></iron-icon>
            <div>Clone</div>
          </button>
          <button on-click="fitElement">
            <iron-icon icon="designer:fit"></iron-icon>
            <div>Fit to parent</div>
          </button>
        </div>
        <div class="actions">
          <button on-click="moveUp" title="or with Shift+UpArrow">
            <iron-icon icon="designer:up"></iron-icon>
            <div>Move up</div>
          </button>
          <button on-click="moveDown" title="or with Shift+DownArrow">
            <iron-icon icon="designer:down"></iron-icon>
            <div>Move down</div>
          </button>
          <button on-click="moveBack" title="or with Shift+LeftArrow">
            <iron-icon icon="designer:back"></iron-icon>
            <div>Move back</div>
          </button>
          <button on-click="moveForward" title="or with Shift+RightArrow">
            <iron-icon icon="designer:forward"></iron-icon>
            <div>Move forward</div>
          </button>
        </div>
        <designer-tabs attr-for-selected="name" selected="{{stylePage}}">
          <designer-tab name="properties">
            <button>properties</button>
          </designer-tab>
          <designer-tab name="styles">
            <button>styles</button>
          </designer-tab>
          <designer-tab name="flex">
            <button>flex</button>
          </designer-tab>
        </designer-tabs>
        <iron-pages class="styles" role="main" selected="[[stylePage]]" attr-for-selected="name" selected-attribute="visible">
          <element-properties name="properties" id="propertiesContainer"></element-properties>
          <element-styles name="styles" id="stylesContainer"></element-styles>
          <element-flex name="flex" id="flexContainer"></element-flex>
        </iron-pages>
        <designer-tabs attr-for-selected="name" selected="{{viewPage}}">
          <designer-tab name="elements">
            <button>Palette</button>
          </designer-tab>
          <designer-tab name="samples">
            <button>Samples</button>
          </designer-tab>
        </designer-tabs>
        <iron-pages class="elements" selected="[[viewPage]]" attr-for-selected="name" selected-attribute="visible">
          <elements-palette name="elements" id="elementsPalette"></elements-palette>
          <samples-palette name="samples"></samples-palette>
        </iron-pages>
      </div>
    </div>

    <form id="jsFiddleForm" hidden method='post' action='http://jsfiddle.net/api/post/library/pure/' target='check'>
      <input type='submit'/>
      <textarea name='html'></textarea>
      <input name='title'/>
      <input name='description'>
    </form>

  </template>
  <script>
    class AppShell extends Polymer.Element {
      static get is() { return 'app-shell'; }
      static get properties() {
        return {
          activeElement: {
            type: Object
          },
          activeElementName: {
            type: String
          },
          stylesPage: {
            type:String
          },
          viewPage: {
            type:String
          }
        }
      }

      ready() {
        super.ready();
        this.stylePage = 'properties';
        this.viewPage = 'elements';

        this.activeElement = this.$.viewContainer;
        this.refreshView();

        this.addEventListener('new-element', this.createElement.bind(this));
        this.addEventListener('new-sample', this.createSample.bind(this));
        this.addEventListener('element-updated', function(event) {
          let detail = event.detail;
          let oldValue = this.updateActiveElementValues(detail.type, detail.name, detail.value);
          // Update the history.
          this.$.actionHistory.add('update', this.activeElement,
            {type: detail.type, name: detail.name, newValue: detail.value, oldValue: oldValue});
        }.bind(this));
        this.addEventListener('remove-from-canvas', function(event){
          this.$.viewContainer.remove(event.detail.target);
          this.$.viewContainer.click();
        }.bind(this));
        this.addEventListener('add-to-canvas', function(event){
          this.$.viewContainer.add(event.detail.target);
          event.detail.target.click();
        }.bind(this));
      }

      /*
       * Updates the new active element in the view.
       */
      setActiveElement(el) {
        if (this.activeElement) {
          this.activeElement.classList.remove('active');
        }
        el.classList.add('active');
        this.activeElement = el;
        this.computeActiveElementName();
      }

      /*
       * Adds a new element to the view.
       */
      createElement(event) {
        let tag = event.detail.type.toLowerCase();
        let el = document.createElement(tag);
        this.$.viewContainer.add(el);

        // If we haven't before, save this initial state of a <tag> element,
        // so that we can diff it to produce the actual state of the world
        codeView.save(tag, event.detail.package, el, getProtoProperties(el));
        this.$.actionHistory.add('new', el);

        this._finishNewElement(el, tag);
        // You need the item to render first.
        requestAnimationFrame(function() {
          el.click();
        });
      }

      /*
       * Adds a new sample code to the view.
       * TODO: there's no tabula rasa for children in this sample.
       */
      createSample(event) {
        let template = event.detail.template;
        let templateTag = event.detail.tag;

        // Clone the template and add it to the document.
        let children = template.content.children;
        for (let i = 0; i < children.length; i++) {
          let el = document.importNode(children[i], true);
          this.$.viewContainer.add(el);
          this.$.actionHistory.add('new', el);
          let tag = el.tagName.toLowerCase();
          el.id = this._makeUniqueId(el, el.id || tag);
        }

        // Position the sample better.
        if (templateTag !== 'app-layout-sample') {
          el.style.position = 'absolute';
          el.style.left = el.style.top = '20px';
        }
        this.refreshView();
      }

      /**
       * Deletes the active element.
       */
      deleteElement() {
        if (!this.activeElement) {
          return;
        }

        let el = this.activeElement;
        // Deleting the top level app should remove its children.
        if (el.id === 'viewContainer') {
          this.$.actionHistory.add('delete', el, {innerHTML: el.getInnerHTML()});
          el.setInnerHTML('');
        } else {
          let parent = el.parentElement;
          parent.removeChild(el);
          this.setActiveElement(parent);
          this.$.actionHistory.add('delete', el, {parent: parent});
        }
        this.refreshView();
      }

      /**
       * Creates a sibling copy of the active element.
       */
      cloneElement() {
        if (!this.activeElement || this.activeElement.id == 'viewContainer') {
          return;
        }

        let el = this.activeElement;
        let clone = el.cloneNode(true);
        el.parentNode.appendChild(clone);
        let tag = clone.tagName.toLowerCase();
        clone.id = this._makeUniqueId(clone, tag);
        this._finishNewElement(clone, tag, true);

        // Go through the children and reset their IDs too.
        let children = clone.querySelectorAll('*');
        for (let i = 0; i < children.length; i++) {
          children[i].id = this._makeUniqueId(children[i], children[i].tagName.toLowerCase());
        }

        // P.S: Since we did a clone, we already have the initial state of the <tag>.
        this.$.actionHistory.add('new', clone);
        this.refreshView();
      }

      /**
       * Refreshes all the properties/styles of the active element.
       */
      refreshView() {
        let el = this.activeElement ? this.activeElement : this.$.viewContainer;

        // Display its properties in the side view.
        let computedStyle = window.getComputedStyle(el);
        this.$.propertiesContainer.display(el);
        this.$.stylesContainer.display(computedStyle);
        this.$.flexContainer.display(computedStyle);

        // Highlight it in the tree.
        this.$.treeView.recomputeTree(this.$.viewContainer, el);

        // If we're looking at the code, refresh that too.
        if (!this.$.codeContainer.hidden) {
          this.viewCode();
        }
      }

      refreshViewWhileTracking() {
        let size = this.activeElement.getBoundingClientRect();
        this.$.stylesContainer.display({top: size.top + 'px', left: size.left + 'px'});
      }

      /**
       * Fit an element to its target
       */
      fitElement() {
        let el = this.activeElement;
        if (!el || el.id === 'viewContainer') {
          return;
        }
        this.$.actionHistory.add('fit', el,
          {oldPosition: el.style.position,
          newPosition: 'absolute',
          oldLeft: el.style.left, oldTop: el.style.top,
          newLeft: '0', newTop: '0',
          oldWidth: el.style.width, oldHeight: el.style.height,
          newWidth: '100%', newHeight: '100%'});

        el.style.position = 'absolute';
        el.style.left = el.style.top = '0px';
        el.style.height = el.style.width = '100%';
      }

      /**
       * Updates the active element's displayed values.
       */
      updateActiveElementValues(type, name, value) {
        let previousValue;

        if (type === 'style') {
          // If we switch to flexbox, automatically reposition the children
          if (name === 'display' && value === 'flex') {
            let children = this.activeElement.children;
            for (let i = 0; i < children.length; i++) {
              children[i].style.position = 'relative';
              children[i].style.top = children[i].style.left = 'auto';
            }
          }
          previousValue = this.activeElement.style[name];
          this.activeElement.style[name] = value;
        } else {
          previousValue = this.activeElement[name];
          if (value === 'true') {
            this.activeElement[name] = true;
          } else if (value === 'false') {
            if (this.activeElement.hasAttribute(name)) {
              this.activeElement.removeAttribute(name);
            } else {
              this.activeElement[name] = false;
            }
          } else {
            this.activeElement[name] = value;
          }

          // We're displaying the id, so update it in the title bar.
          if (name === 'id') {
            this.computeActiveElementName();
          }
        }

        this.$.treeView.recomputeTree(this.$.viewContainer, this.activeElement);
        return previousValue;
      }

      /**
       * Moving elements in the DOM
       */
      moveBack(noUpdateHistory) {
        let el = this.activeElement;
        if (el.id === 'viewContainer') {
          return;
        }
        let parent = el.parentElement;
        let previous = el.previousElementSibling;
        if (previous) {
          parent.insertBefore(el, previous);
        } else {
          parent.appendChild(el);
        }
        if (!!noUpdateHistory) {
          this.$.actionHistory.add('move-back', el);
        }
        this.refreshView();
      }

      moveForward(noUpdateHistory) {
        let el = this.activeElement;
        if (el.id === 'viewContainer') {
          return;
        }
        let parent = el.parentElement;

        // Since you can't insertAfter your next sibling, you need to
        // insert before two siblings over.
        let next = el.nextElementSibling;
        if (next) {
          next = next.nextElementSibling;
          if (next) {
            parent.insertBefore(el, next);
          } else {
            parent.appendChild(el);
          }
        } else {
          parent.insertBefore(el, parent.firstChild);
        }
        if (!!noUpdateHistory) {
          this.$.actionHistory.add('move-forward', el);
        }
        this.refreshView();
      }

      moveUp(noUpdateHistory) {
        let el = this.activeElement;
        let parent = el.parentElement;
        // If the parent isn't already the viewContainer, move it one up.
        if (el.id === 'viewContainer' || (parent && parent.id === 'canvas')) {
          return;
        }
        if (!!noUpdateHistory) {
          this.$.actionHistory.add('move-up', el, {oldParent: parent, newParent: parent.parentElement});
        }
        parent.removeChild(el);
        parent.parentElement.appendChild(el);
        this.refreshView();
      }

      moveDown(noUpdateHistory) {
        let el = this.activeElement;
        let sibling = el.nextElementSibling;
        if (el.id === 'viewContainer' || !sibling) {
          return;
        }

        // Not everything accepts children, as we've learnt from canvas-view
        // (where I copied this code from like a lazy bum)
        let slots = sibling.root ? sibling.root.querySelectorAll('slot') : [];
        let canDrop =
          sibling.tagName === 'DIV' || sibling.tagName === 'BUTTON' ||
          sibling.tagName === 'FORM' ||
          slots.length !== 0;

        if (!canDrop) {
          return;
        }

        if (!!noUpdateHistory) {
          this.$.actionHistory.add('move-down', el, {oldParent: el.parentElement, newParent: sibling});
        }

        // If you can, add it there.
        sibling.appendChild(el);
        this.refreshView();
      }

      // TODO: ugh, this can probably be better.
      computeActiveElementName() {
        if (this.activeElement === null || this.activeElement.id == 'viewContainer') {
          this.activeElementName = 'main-app';
        } else {
          let name = this.activeElement.tagName.toLowerCase();
          if (this.activeElement.id) {
            name += '#' + this.activeElement.id;
          }
          this.activeElementName = name;
        }
      }

      jsFiddleIt() {
        let code = window.codeView.get(this.$.viewContainer);
        let form = this.$.jsFiddleForm;
        form.html.value = code;
        form.title.value = 'Your sample app';
        //form.title.description = 'Autogenerated with Polyweaver';
        form.submit();
      }

      viewCode(event) {
        if (event && this.toggleMainView(event.currentTarget)) {
          return;
        }

        let newEvent = new Event('update-code', {
          bubbles: true,
          cancelable: false,
          composed: true
        });
        newEvent.detail = {target: this.$.viewContainer};
        this.dispatchEvent(newEvent);
      }

      toggleMainView(button) {
        let showMain = button.classList.contains('active');

        if (showMain) {
          button.classList.remove('active');
        } else {
          button.classList.add('active');
        }

        this.$.viewContainer.hidden = !showMain;
        this.$.codeContainer.hidden = showMain;
        return showMain;
      }

      updateUndoButton(length) {
        this.$.undoBtn.disabled = (length === 0);
      }
      updateRedoButton(length) {
        this.$.redoBtn.disabled = (length === 0);
      }
      undo() {
        this.$.actionHistory.undo();
      }
      redo() {
        this.$.actionHistory.redo();
      }

      /**
       * Initializes a new element that has just been added to the canvas.
       */
      _finishNewElement(el, tag, isClone) {
        el.style.position = 'absolute';
        el.style.left = el.style.top = '20px';
        el.id = this._makeUniqueId(el, tag);

        if (isClone) {
          return;
        }
        let slots = el.root ? el.root.querySelectorAll('slot') : [];
        // TODO: fix this and make it less this and more something else.
        if (tag === 'div') {
          el.style.height = el.style.width = '200px';
          el.style.backgroundColor = '#CDDC39';
          el.textContent = 'div';
        } else if (tag === 'input') {
          el.placeholder = 'input';
        } else if (tag === 'form') {
          el.style.height = el.style.width = '200px';
          el.style.backgroundColor = 'white';
        } else if (tag === 'button' || slots.length != 0) {
          el.textContent = tag;
        }
      }

      _makeUniqueId(node, id, suffix) {
        id = id.replace('-', '_');
        let uId = id + (suffix || '');
        return this.$.viewContainer.has('#' + uId) ?
          this._makeUniqueId(node, id, suffix ? ++suffix : 1) : uId;
      }
    }
    customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>
