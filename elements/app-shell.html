<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<link rel="import" href="app-icons.html">
<link rel="import" href="designer-tabs.html">
<link rel="import" href="designer-tab.html">
<link rel="import" href="elements-view.html">

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.8/ace.js" type="text/javascript" charset="utf-8"></script>
<dom-module id="app-shell">
  <template>
    <style>
      :host{
        display: block;
        box-sizing: border-box;
        position: relative;
      }

      app-header {
        background-color: #373737;
        color: white;
        height: 60px;
        width: 100%;
        position: fixed;
        z-index: 100;
      }

      app-header span {
        margin-right: 8px;
      }

      app-header paper-icon-button {
        margin: 8px;
      }

      .separator {
        border-left: #656565 solid 1px;
        opacity: .8;
        height: 24px;
        margin: 8px;
      }

      .container {
        box-sizing: border-box;
        display: flex;
        flex-direction: row;
        padding-top: 60px;
        height: 100vh;
      }

      .drawer {
        width: 350px;
        height: 100%;
        overflow: auto;
        background: white;
        color: #5d5d5d;
      }

      .drawer.small {
        width: 250px;
      }

      .main {
        height: 100%;
        overflow: auto;
        display: flex;
        flex-grow: 1;
        border-left: 1px solid #e5e5e5;
        border-right: 1px solid #e5e5e5;
      }

      .drawer-title {
        padding: 14px 0;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        line-height: 1.5;
        color: inherit;
      }

      [hidden] {
        display: none !important;
      }

      iron-pages {
        padding: 8px 14px;
        overflow: auto;
      }

      .button-code {
        transform: rotate(0deg);
      }

      .button-code.active {
        transform: rotate(90deg);
      }
    </style>

    <app-header fixed scroll-target="scrollingRegion">
      <app-toolbar>
        <span title="it's like MSPaint but for Polymer apps">PolymerPaint</span>
        <div class="separator"></div>
        <elements-view></elements-view>

        <paper-icon-button class="button-code" icon="designer:code" on-click="dump"></paper-icon-button>
        <div class="separator"></div>
        <paper-icon-button disabled icon="designer:undo"></paper-icon-button>
        <paper-icon-button disabled icon="designer:redo"></paper-icon-button>
      </app-toolbar>
    </app-header>
    <div class="container" id="scrollingRegion">
      <div class="drawer small">
        <designer-tabs attr-for-selected="name" selected="tree">
          <designer-tab name="tree">
            <button>tree</button>
            <paper-icon-button icon="designer:delete" on-click="deleteActiveElement"></paper-icon-button>
          </designer-tab>
        </designer-tabs>
        <div name="tree">
          <slot name="tree"></slot>
        </div>
      </div>

      <div class="main" id="mainContainer">
        <slot name="main"></slot>
      </div>
      <div class="main" id="codeContainer" hidden>
        <slot name="code"></slot>
      </div>

      <div class="drawer">
        <designer-tabs attr-for-selected="name" selected="{{stylePage}}">
          <designer-tab name="properties">
            <button>properties</button>
          </designer-tab>
          <designer-tab name="styles">
            <button>styles</button>
          </designer-tab>
          <designer-tab name="flex">
            <button>flex</button>
          </designer-tab>
        </designer-tabs>
        <iron-pages class="styles" role="main" selected="[[stylePage]]" attr-for-selected="name" selected-attribute="visible">
          <div name="properties">
            <slot name="properties"></slot>
          </div>
          <div name="styles">
            <slot name="styles"></slot>
          </div>
          <div name="flex">
            <slot name="flex"></slot>
          </div>
        </iron-pages>
      </div>
    </div>

  </template>
  <script>
    class AppShell extends Polymer.Element {
      static get is() { return 'app-shell'; }
      static get properties() {
        return {
          activeElement: {
            type: Object
          },
          activeElementName: {
            type: String
          },
          stylesPage: {
            type:String
          },
          elementsPage: {
            type:String
          }
        }
      }

      ready() {
        super.ready();
        this.stylePage = 'properties';
        this.elementsPage = 'elements';
      }

      updateActiveElement(el) {
        if (this.activeElement) {
          this.activeElement.classList.remove('active');
        }
        el.classList.add('active');
        this.activeElement = el;
        this.computeActiveElementName();
      }

      updateActiveElementValues(type, name, value) {
        if (type === 'style') {
          // If we switch to flexbox, automatically reposition the children
          if (name === 'display' && value === 'flex') {
            var children = this.activeElement.children;
            for (var i = 0; i < children.length; i++) {
              children[i].style.position = 'relative';
              children[i].style.top = children[i].style.left = 'auto';
            }
          }
          this.activeElement.style[name] = value;
        } else {
          if (value === 'true') {
            this.activeElement[name] = true;
          } else if (value === 'false') {
            if (this.activeElement.hasAttribute(name)) {
              this.activeElement.removeAttribute(name);
            } else {
              this.activeElement[name] = false;
            }
          } else {
            this.activeElement[name] = value;
          }

          // We're displaying the id, so update it in the title bar.
          if (name === 'id') {
            this.computeActiveElementName();
          }
        }
      }

      deleteActiveElement() {
        // Deleting the whole app should remove the children I guess.
        if (this.activeElement.id === 'viewContainer') {
          this.activeElement.innerHTML = '';
        } else {
          this.activeElement.parentElement.removeChild(this.activeElement);
          this.activeElement = null;
        }
        this.computeActiveElementName();

        var newEvent = new Event('delete-element', {
          bubbles: true,
          cancelable: false,
          composed: true
        });
        this.dispatchEvent(newEvent);
      }

      // TODO: ugh, this can probably be better.
      computeActiveElementName() {
        if (this.activeElement === null || this.activeElement.id == 'viewContainer') {
          this.activeElementName = 'main-app';
        } else {
          var name = this.activeElement.tagName.toLowerCase();
          if (this.activeElement.id) {
            name += '#' + this.activeElement.id;
          }
          this.activeElementName = name;
        }
      }

      dump(event) {
        // TODO: this needs to be a separate element prolly.
        // Imports
        this._imports = '';
        this._template = '';
        this._style = '';

        // Host styles.
        var hostCss = viewContainer.style.cssText.replace(/;/g, `;\n       `).trim();
        var bonusHost = `        ${hostCss}`;

        this.dumpChildren(viewContainer, '    ');

        var boilerplate = `${this._imports.trimRight()}
<dom-module id="main-app">
  <template>
    <style>
      :host {
        position: absolute;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
${bonusHost.trimRight()}
      }
${this._style.trimRight()}
    </style>
${this._template.trimRight()}
  </template>
  <script>
    class MainApp extends Polymer.Element {
      static get is() { return 'main-app'; }
    }
    customElements.define(MainApp.is, MainApp);
  &lt;/script>
</dom-module>`;
        boilerplate = boilerplate.replace(/&lt;/g, '<');

        var newEvent = new Event('update-code', {
          bubbles: true,
          cancelable: false,
          composed: true
        });
        newEvent.detail = {
          code: boilerplate
        };
        this.dispatchEvent(newEvent);
        this.toggleMainView(event.target);
      }

      dumpChildren(parent, indent) {
        var nodes = parent.children;

        for (var i = 0; i < nodes.length; i++) {
          // Add to the import if needed.
          var tag = nodes[i].tagName.toLowerCase();
          if (tag.indexOf('-') !== -1 && this._imports.indexOf(`${tag}.html`) === -1) {
            this._imports += this.dumpImports(tag, '') + '\n';
          }
          this._style += this.dumpStyle(nodes[i], '      ');

          if (nodes[i].children.length !== 0) {
            this._template += this.dumpElementStartTag(nodes[i], indent) + '\n';
            this.dumpChildren(nodes[i], indent + '  ') + '\n';
            this._template += this.dumpElementEndTag(nodes[i], indent) + '\n';
          } else {
            this._template += this.dumpElement(nodes[i], indent) + '\n';
          }
        }
      }

      dumpElement(node, indent) {
        var tag = node.tagName.toLowerCase();
        var id = node.id ? ` id="${node.id}"` : '';
        var text = node.textContent || '';
        return tag === 'input' ?
            `${indent}<${tag}${id}>` :
            `${indent}<${tag}${id}>${text}</${tag}>`
      }
      dumpElementStartTag(node, indent) {
        var tag = node.tagName.toLowerCase();
        var id = node.id ? ` id="${node.id}"` : '';
        return `${indent}<${tag}${id}>`;
      }
      dumpElementEndTag(node, indent) {
        var tag = node.tagName.toLowerCase();
        return `${indent}</${tag}>`;
      }

      dumpStyle(node, indent) {
        var tag = node.tagName.toLowerCase();
        var css = node.style.cssText.replace(/;/g, `;\n${indent} `).trim();
        var id = node.id ? '#' + node.id : '';
        return `${indent}${tag}${id} {
${indent}  ${css}
${indent}}
`
      }

      dumpImports(tag, indent) {
        return `${indent}<link rel="import" href="../${tag}/${tag}.html">`;
      }

      toggleMainView(button) {
        var showMain = button.classList.contains('active');

        if (showMain) {
          button.classList.remove('active');
        } else {
          button.classList.add('active');
        }

        this.$.mainContainer.hidden = !showMain;
        this.$.codeContainer.hidden = showMain;
      }

    }
    customElements.define(AppShell.is, AppShell);
  </script>
</dom-module>
